# Testing Structure and Conventions

This document explains how tests are organized in the frontend, where datasets live, and how to extend or add more tests in a maintainable way.

## Directory layout

- tests/
  - setup.ts                 // Vitest setup (globals, polyfills, etc.)
  - README.md                // High-level testing info (existing)
  - TESTING_STRUCTURE.md     // This document
  - unit/
    - services/
      - comprehensive-modal-individual-validation.test.ts
        - Runs 1 test per row from comprehensive-modal-test-cases.json
        - Validates modal analysis strictly and (Phase V1) also asserts functional & comprehensive orchestration behavior category-wise
      - comprehensive-dataset-validation.test.ts
        - Validates a curated TS dataset across FunctionalHarmonyAnalyzer and ComprehensiveAnalysisEngine
    - helpers/               // Put reusable helpers here (assertions, analyzer runners)
    - utils/, constants/     // Utility tests

## Datasets

- frontend/comprehensive-modal-test-cases.json
  - Generated by frontend/generate-comprehensive-test-cases.cjs
  - Contains 7 categories: modal_characteristic, modal_seventh_variant, modal_vamp, modal_foil, functional_clear, ambiguous, edge_case
  - Used by comprehensive-modal-individual-validation.test.ts

- Test dataset utilities live in src/test-data (for TS-based curated suites).

## Conventions

- Prefer resolving files relative to __dirname rather than process.cwd() for robust pathing in tests.
- Keep assertions readable and categorized: group expectations by category to reduce noise.
- Reuse helpers for running analyzers and common assertions (place in tests/unit/helpers/). If adding new features, add assertion helpers rather than duplicating logic in multiple test files.
- Avoid over-constraining ambiguous/edge categories; assert confidence ranges and presence of explanations instead of exact labels.

## How to run

- From the frontend directory:
  - All unit tests: `npm test` or `npx vitest`
  - Modal JSON-driven suite only: `npm run test:modal` (if defined) or `vitest run tests/unit/services/comprehensive-modal-individual-validation.test.ts`
  - Comprehensive curated dataset: `vitest run tests/unit/services/comprehensive-dataset-validation.test.ts`

## Extending tests

- For new modal cases, update the generator (frontend/generate-comprehensive-test-cases.cjs) and re-generate the JSON. Keep category semantics consistent.
- To validate new analysis features deterministically, consider extending the JSON schema with optional expectedFunctional/expectedComprehensive/expectedModalDetails fields (backward compatible). Guard assertions to only run when fields are present.
- If multiple suites need the same analyzer execution logic, move it into tests/unit/helpers/analyzerTestUtils.ts.

## Phase notes

- Phase 0: This document, robust path resolution, and clear categorization aims to make the structure self-explanatory and easier to maintain.
- Phase V1: The modal JSON suite now also validates FunctionalHarmonyAnalyzer and ComprehensiveAnalysisEngine per category thresholds.

Tip: Enable/disable the new Phase V1 assertions in the modal JSON suite by setting env var `V1_ASSERTIONS=1` when running Vitest to turn them on. Without this flag, the suite behaves as before (modal-first checks only), which is useful if you are iterating on analyzer thresholds.
